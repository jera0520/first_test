---
alwaysApply: true
description: "Project structure and organization guidelines for SKINMATE"
---

# ğŸ—ï¸ SKINMATE Project Structure & Organization Rules

## ğŸ“ MANDATORY PROJECT STRUCTURE

The current flat structure with monolithic [app.py](mdc:app.py) (1061 lines) MUST be refactored into the following organized structure:

```
skinmate/
â”œâ”€â”€ ğŸ“ app/                          # Main application package
â”‚   â”œâ”€â”€ __init__.py                  # Application factory
â”‚   â”œâ”€â”€ config.py                    # Configuration management
â”‚   â”œâ”€â”€ ğŸ“ models/                   # Data models (SQLAlchemy)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user.py                  # User model
â”‚   â”‚   â”œâ”€â”€ analysis.py              # Analysis model
â”‚   â”‚   â””â”€â”€ product.py               # Product model
â”‚   â”œâ”€â”€ ğŸ“ routes/                   # Route blueprints
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ auth.py                  # Authentication routes
â”‚   â”‚   â”œâ”€â”€ analysis.py              # Skin analysis routes
â”‚   â”‚   â”œâ”€â”€ api.py                   # API endpoints
â”‚   â”‚   â””â”€â”€ main.py                  # Main page routes
â”‚   â”œâ”€â”€ ğŸ“ services/                 # Business logic layer
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ analysis_service.py      # Skin analysis logic
â”‚   â”‚   â”œâ”€â”€ model_service.py         # AI model management
â”‚   â”‚   â”œâ”€â”€ recommendation_service.py # Product recommendations
â”‚   â”‚   â””â”€â”€ auth_service.py          # Authentication logic
â”‚   â”œâ”€â”€ ğŸ“ repositories/             # Data access layer
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base_repository.py       # Base repository pattern
â”‚   â”‚   â”œâ”€â”€ user_repository.py       # User data access
â”‚   â”‚   â””â”€â”€ analysis_repository.py   # Analysis data access
â”‚   â”œâ”€â”€ ğŸ“ utils/                    # Utility functions
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ validators.py            # Input validation
â”‚   â”‚   â”œâ”€â”€ decorators.py            # Custom decorators
â”‚   â”‚   â”œâ”€â”€ security.py              # Security utilities
â”‚   â”‚   â””â”€â”€ helpers.py               # General helpers
â”‚   â””â”€â”€ ğŸ“ static/                   # Static assets (unchanged)
â”‚       â”œâ”€â”€ css/
â”‚       â”œâ”€â”€ images/
â”‚       â””â”€â”€ uploads_temp/
â”œâ”€â”€ ğŸ“ ml_models/                    # AI/ML related files
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ ğŸ“ models/                   # Model files (.pkl, .tflite)
â”‚   â”‚   â”œâ”€â”€ my_xgboost_model.pkl
â”‚   â”‚   â”œâ”€â”€ my_scaler.pkl
â”‚   â”‚   â”œâ”€â”€ my_selector.pkl
â”‚   â”‚   â”œâ”€â”€ filename.tflite
â”‚   â”‚   â””â”€â”€ moisture.tflite
â”‚   â”œâ”€â”€ ğŸ“ services/                 # ML service layer
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ model_manager.py         # Model loading/management
â”‚   â”‚   â”œâ”€â”€ skin_analyzer.py         # Skin analysis logic
â”‚   â”‚   â””â”€â”€ image_processor.py       # Image preprocessing
â”‚   â””â”€â”€ ğŸ“ config/                   # ML configuration
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ model_config.py          # Model configurations
â”œâ”€â”€ ğŸ“ database/                     # Database related files
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ ğŸ“ migrations/               # Database migrations
â”‚   â”‚   â””â”€â”€ versions/
â”‚   â”œâ”€â”€ schema.sql                   # Base schema
â”‚   â””â”€â”€ seed_data.py                 # Seed data for development
â”œâ”€â”€ ğŸ“ tests/                        # Test suite
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ conftest.py                  # Test configuration
â”‚   â”œâ”€â”€ ğŸ“ unit/                     # Unit tests
â”‚   â”‚   â”œâ”€â”€ test_models.py
â”‚   â”‚   â”œâ”€â”€ test_services.py
â”‚   â”‚   â””â”€â”€ test_repositories.py
â”‚   â”œâ”€â”€ ğŸ“ integration/              # Integration tests
â”‚   â”‚   â”œâ”€â”€ test_routes.py
â”‚   â”‚   â””â”€â”€ test_api.py
â”‚   â””â”€â”€ ğŸ“ fixtures/                 # Test fixtures
â”‚       â”œâ”€â”€ test_images/
â”‚       â””â”€â”€ mock_models/
â”œâ”€â”€ ğŸ“ config/                       # Environment configurations
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ development.py               # Development config
â”‚   â”œâ”€â”€ production.py                # Production config
â”‚   â””â”€â”€ testing.py                   # Testing config
â”œâ”€â”€ ğŸ“ logs/                         # Log files
â”‚   â”œâ”€â”€ app.log
â”‚   â”œâ”€â”€ security.log
â”‚   â””â”€â”€ crawler.log
â”œâ”€â”€ ğŸ“ scripts/                      # Utility scripts
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ deploy.py                    # Deployment script
â”‚   â”œâ”€â”€ backup_db.py                 # Database backup
â”‚   â””â”€â”€ migrate_legacy.py            # Legacy code migration
â”œâ”€â”€ ğŸ“ docs/                         # Documentation
â”‚   â”œâ”€â”€ api.md                       # API documentation
â”‚   â”œâ”€â”€ setup.md                     # Setup instructions
â”‚   â””â”€â”€ security.md                  # Security guidelines
â”œâ”€â”€ .env.example                     # Environment variables template
â”œâ”€â”€ .gitignore                       # Git ignore rules
â”œâ”€â”€ requirements.txt                 # Python dependencies
â”œâ”€â”€ requirements-dev.txt             # Development dependencies
â”œâ”€â”€ Dockerfile                       # Docker configuration
â”œâ”€â”€ docker-compose.yml               # Docker compose for development
â”œâ”€â”€ pytest.ini                       # Pytest configuration
â”œâ”€â”€ .flake8                          # Linting configuration
â””â”€â”€ README.md                        # Project documentation
```

## ğŸ¯ MODULE ORGANIZATION PRINCIPLES

### âœ… SEPARATION OF CONCERNS
```python
# âŒ CURRENT STATE: Everything mixed in app.py
@app.route('/analyze', methods=['POST'])
def analyze_image():
    # Authentication logic
    # File validation
    # Image processing
    # AI inference
    # Database operations
    # Business logic
    # Response generation
    # 95+ lines of mixed responsibilities!

# âœ… REFACTORED: Clear separation
# routes/analysis.py
@analysis_bp.route('/upload', methods=['POST'])
@login_required
@validate_input(ImageUploadSchema)
def upload_image():
    """Handle image upload - SINGLE RESPONSIBILITY"""
    return analysis_service.process_upload(request.files['image'])

# services/analysis_service.py
class AnalysisService:
    """Business logic for skin analysis - SINGLE RESPONSIBILITY"""
    def process_upload(self, image_file):
        # Coordinate the analysis workflow
        pass

# repositories/analysis_repository.py
class AnalysisRepository:
    """Data access for analyses - SINGLE RESPONSIBILITY"""
    def save_analysis(self, analysis_data):
        # Database operations only
        pass
```

### âœ… DEPENDENCY DIRECTION
```python
# CORRECT DEPENDENCY FLOW:
# Routes â†’ Services â†’ Repositories â†’ Models
# Higher level modules depend on lower level modules

# routes/analysis.py (HIGH LEVEL)
from app.services.analysis_service import AnalysisService

# services/analysis_service.py (MIDDLE LEVEL)
from app.repositories.analysis_repository import AnalysisRepository
from ml_models.services.skin_analyzer import SkinAnalyzer

# repositories/analysis_repository.py (LOW LEVEL)
from app.models.analysis import Analysis

# âŒ NEVER DO: Circular dependencies
# services importing routes
# models importing services
```

## ğŸ“‹ FILE NAMING CONVENTIONS

### âœ… NAMING STANDARDS
```python
# Class files: snake_case.py
user_repository.py      # Contains UserRepository class
skin_analyzer.py        # Contains SkinAnalyzer class
model_service.py        # Contains ModelService class

# Blueprint files: descriptive names
auth.py                 # Authentication routes
analysis.py             # Analysis routes
api.py                  # API endpoints

# Test files: test_ prefix
test_user_repository.py
test_analysis_service.py
test_auth_routes.py

# Configuration files: environment names
development.py
production.py
testing.py
```

### âŒ AVOID THESE PATTERNS
```python
# âŒ BAD: Generic names
utils.py               # Too generic - what kind of utils?
helpers.py             # Too vague - helpers for what?
main.py               # Unclear purpose in large project

# âŒ BAD: Mixed naming conventions
UserRepository.py      # Should be user_repository.py
analysisService.py     # Should be analysis_service.py
API_Routes.py          # Should be api_routes.py
```

## ğŸ”§ CONFIGURATION MANAGEMENT

### âœ… ENVIRONMENT-BASED CONFIG
```python
# config/__init__.py
import os
from .development import DevelopmentConfig
from .production import ProductionConfig
from .testing import TestingConfig

config = {
    'development': DevelopmentConfig,
    'production': ProductionConfig,
    'testing': TestingConfig
}

def get_config():
    """Get configuration based on environment."""
    return config[os.environ.get('FLASK_ENV', 'development')]

# config/base.py
class BaseConfig:
    """Base configuration with common settings."""
    
    # Security
    SECRET_KEY = os.environ.get('SECRET_KEY')
    
    # Database
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    
    # File uploads
    MAX_CONTENT_LENGTH = 10 * 1024 * 1024  # 10MB
    UPLOAD_FOLDER = os.environ.get('UPLOAD_FOLDER', 'uploads')
    
    # ML Models
    MODEL_PATH = os.environ.get('MODEL_PATH', 'ml_models/models')
    
    @staticmethod
    def init_app(app):
        """Initialize app with this configuration."""
        pass

# config/production.py
class ProductionConfig(BaseConfig):
    """Production configuration with security hardening."""
    
    DEBUG = False
    TESTING = False
    
    # Security settings
    SESSION_COOKIE_SECURE = True
    SESSION_COOKIE_HTTPONLY = True
    SESSION_COOKIE_SAMESITE = 'Lax'
    
    # Database
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL')
    
    @staticmethod
    def init_app(app):
        """Initialize production app."""
        BaseConfig.init_app(app)
        
        # Production-specific initialization
        if not app.config['SECRET_KEY']:
            raise ValueError('SECRET_KEY must be set in production')
```

## ğŸ“¦ PACKAGE INITIALIZATION

### âœ… PROPER __init__.py FILES
```python
# app/__init__.py - Application Factory
from flask import Flask
from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate

db = SQLAlchemy()
migrate = Migrate()

def create_app(config_name='development'):
    """Application factory pattern."""
    app = Flask(__name__)
    
    # Load configuration
    from config import get_config
    app.config.from_object(get_config())
    
    # Initialize extensions
    db.init_app(app)
    migrate.init_app(app, db)
    
    # Register blueprints
    from app.routes.auth import auth_bp
    from app.routes.analysis import analysis_bp
    from app.routes.api import api_bp
    from app.routes.main import main_bp
    
    app.register_blueprint(auth_bp, url_prefix='/auth')
    app.register_blueprint(analysis_bp, url_prefix='/analysis')
    app.register_blueprint(api_bp, url_prefix='/api')
    app.register_blueprint(main_bp)
    
    return app

# app/models/__init__.py - Model Registration
from .user import User
from .analysis import Analysis
from .product import Product

__all__ = ['User', 'Analysis', 'Product']

# app/services/__init__.py - Service Registration
from .analysis_service import AnalysisService
from .auth_service import AuthService
from .model_service import ModelService

__all__ = ['AnalysisService', 'AuthService', 'ModelService']
```

## ğŸ§ª TESTING STRUCTURE

### âœ… COMPREHENSIVE TEST ORGANIZATION
```python
# tests/conftest.py - Test Configuration
import pytest
from app import create_app, db

@pytest.fixture
def app():
    """Create application for testing."""
    app = create_app('testing')
    with app.app_context():
        db.create_all()
        yield app
        db.drop_all()

@pytest.fixture
def client(app):
    """Create test client."""
    return app.test_client()

# tests/unit/test_services/test_analysis_service.py
class TestAnalysisService:
    """Unit tests for AnalysisService."""
    
    def test_analyze_valid_image(self, mock_dependencies):
        """Test analysis with valid image."""
        pass

# tests/integration/test_routes/test_analysis_routes.py
class TestAnalysisRoutes:
    """Integration tests for analysis routes."""
    
    def test_upload_endpoint_with_auth(self, client, auth_headers):
        """Test upload endpoint with authentication."""
        pass
```

## ğŸ“‹ MIGRATION CHECKLIST

### ğŸ¯ REFACTORING PRIORITIES

1. **IMMEDIATE (Security Critical)**
   - [ ] Move hardcoded SECRET_KEY to environment variables
   - [ ] Implement secure file upload validation
   - [ ] Add input sanitization and validation

2. **HIGH PRIORITY (Architecture)**
   - [ ] Extract route handlers from [app.py](mdc:app.py) into blueprints
   - [ ] Create service layer for business logic
   - [ ] Implement repository pattern for data access

3. **MEDIUM PRIORITY (Organization)**
   - [ ] Separate ML models into dedicated package
   - [ ] Create proper configuration management
   - [ ] Implement comprehensive error handling

4. **LOW PRIORITY (Quality)**
   - [ ] Add comprehensive test suite
   - [ ] Implement logging and monitoring
   - [ ] Create documentation

### ğŸ”„ MIGRATION STRATEGY
```python
# scripts/migrate_legacy.py
"""Script to assist with legacy code migration."""

class LegacyMigrator:
    """Helper for migrating from monolithic structure."""
    
    def extract_routes(self, source_file: str, target_dir: str):
        """Extract route handlers into blueprint files."""
        # Implementation to parse app.py and extract routes
        pass
    
    def create_service_layer(self, business_logic: dict):
        """Create service classes from extracted business logic."""
        # Implementation to create service files
        pass
    
    def migrate_database_calls(self, source_dir: str):
        """Convert direct DB calls to repository pattern."""
        # Implementation to create repository classes
        pass
```

---

**CRITICAL TASK**: The current monolithic structure MUST be refactored according to this organization. Start with security fixes, then proceed with architectural separation. This is not optional for maintainable, scalable application development.