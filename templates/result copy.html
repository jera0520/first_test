{% extends "base.html" %}

{% block title %}ë¶„ì„ ê²°ê³¼ ë° ì¶”ì²œ - SKINMATE{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/recommendations.css') }}">
<style>
    /* Chart Styles */
    .chart-container { display: flex; justify-content: center; align-items: center; padding: 20px; }
    .chart-item { flex: 1; padding: 10px; }
    .flex-spacer { flex: 0.5; }
    #segmented-bars-container { display: flex; flex-direction: column; }
    .bar-container { display: flex; align-items: center; margin-bottom: 20px; width: 100%; }
    .bar-label { width: 50px; font-weight: bold; font-size: 16px; word-break: keep-all; white-space: nowrap; }
    .segmented-bar { display: flex; width: 100%; flex-grow: 1; height: 25px; border-radius: 5px; overflow: hidden; border: 1px solid #e0e0e0; }
    .segment { flex: 1; background-color: #f0f0f0; border-left: 1px solid #fff; }
    .segment:first-child { border-left: none; }
    .segment.filled { background-color: #D8AAAA; }

    /* Modal Styles */
    .modal {
        display: none; 
        position: fixed; 
        z-index: 1000; 
        left: 0;
        top: 0;
        width: 100%; 
        height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.6);
    }
    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 40px;
        border: 1px solid #888;
        width: 80%;
        max-width: 900px;
        border-radius: 10px;
        position: relative;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .close-button {
        color: #aaa;
        position: absolute;
        top: 15px;
        right: 25px;
        font-size: 35px;
        font-weight: bold;
    }
    .close-button:hover,
    .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}

<div class="prescription-container">
    {% if recommendations and recommendations.user_info %}
    <button id="toggleInfoBtn" class="info-toggle-button">âš ï¸ ì‚¬ìš© ì „ ì•ˆë‚´ì‚¬í•­ì„ ê¼­ ì½ì–´ì£¼ì„¸ìš”</button>
    <div class="user-info-card">
        <img src="{{ url_for('static', filename='images/logo_icon_img.jpg') }}" alt="SKINMATE Logo" class="prescription-logo">
        <h2>&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspAI í”¼ë¶€ ë¶„ì„ ê²°ê³¼&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp</h2>
        <p class="username">&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp<span class="rt_user_name">{{ recommendations.user_info.username }}</span>&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp<span class="rt_user_name_nim">ë‹˜</span></p>
        <p class="skin-type-label">í”¼ë¶€ íƒ€ì…ì€&nbsp;&nbsp;&nbsp;<span class="skin-type-highlight">{{ skin_type }}</span>&nbsp;&nbsp;&nbsp;ì…ë‹ˆë‹¤</p>
        <div class="my-type-icon">
            {% if scores %}
                <span class="score-item">ìˆ˜ë¶„ <img src="{{ url_for('static', filename='images/' + get_face_icon(scores.moisture)) }}" alt="ìˆ˜ë¶„ ì ìˆ˜ ì•„ì´ì½˜" class="score-face-icon"></span>
                <span class="score-item">íƒ„ë ¥ <img src="{{ url_for('static', filename='images/' + get_face_icon(scores.elasticity)) }}" alt="íƒ„ë ¥ ì ìˆ˜ ì•„ì´ì½˜" class="score-face-icon"></span>
                <span class="score-item">ì£¼ë¦„ <img src="{{ url_for('static', filename='images/' + get_face_icon(scores.wrinkle)) }}" alt="ì£¼ë¦„ ì ìˆ˜ ì•„ì´ì½˜" class="score-face-icon"></span>
            {% endif %}
        </div>
        <button id="showResultModalBtn" class="result-button-recommend">ìì„¸íˆ ë³´ê¸° ></button>
        <p class="prescription-date">
            <span class="date-num">{{ recommendations.user_info.date_info.year }}</span><span class="date-unit">ë…„</span>
            <span class="date-num">{{ recommendations.user_info.date_info.month }}</span><span class="date-unit">ì›”</span>
            <span class="date-num">{{ recommendations.user_info.date_info.day }}</span><span class="date-unit">ì¼</span>
        </p>
        <p class="drugstore-name">&nbsp&nbsp&nbspìŠ¤í‚¨ë©”ì´íŠ¸ì—°êµ¬ì†Œ&nbsp&nbsp&nbsp</p>
        <p class="all-dirtk"><span class="dirtk">ì—°êµ¬ì›</span>&nbsp&nbsp&nbsp&nbsp&nbsp<span class="dirtkdlfma">ê¹€í”¼ë¶€</span></p>
        <p>ê²½ìƒë¶ë„ ì•ˆë™ì‹œ ê²½ë™ë¡œ 1375</p>
        <p>TEL. 054)123-4567</p>
    </div>
    {% else %}
    <div class="no-products">
        <h3>ì•„ì§ ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</h3>
        <p>í”¼ë¶€ ë¶„ì„ì„ ë¨¼ì € ì§„í–‰í•´ì£¼ì„¸ìš”.</p>
        <a href="/analysis" class="product-link">ë¶„ì„í•˜ê¸°</a>
    </div>
    {% endif %}

    {% if recommendations %}
    <!-- The Modal for Info -->
    <div id="infoModal" class="modal">
      <div class="modal-content">
        <span class="close-button info-close">&times;</span>
        <div class="info-section">
            <div class="qa-section">
                <h4>Only! ë‚˜ë§Œì„ ìœ„í•œ ì¶”ì²œì´ì—ìš”!</h4>
                <p>SKINMATEëŠ” ê·¸ëƒ¥ ì¸ê¸°ìˆœìœ¼ë¡œ ì œí’ˆì„ ì¶”ì²œí•˜ì§€ ì•Šì•„ìš”.<br>ìš°ë¦¬ í”¼ë¶€ ê³ ë¯¼, í”¼ë¶€ íƒ€ì…, ê·¸ë¦¬ê³  ê³„ì ˆì— ë§ëŠ” ì œí˜•ê¹Œì§€ ê¼¼ê¼¼í•˜ê²Œ ë”°ì ¸ì„œ ì§€ê¸ˆ ë‹¹ì‹ ì—ê²Œ ê°€ì¥ ì˜ ë§ëŠ” ì œí’ˆì„ ì•Œë ¤ë“œë ¤ìš”.</p>
            </div>
            <div class="tip-section">
                <h4>ğŸ’¡í”¼ë¶€ ê´€ë¦¬ íŒ</h4>
                <p>í”¼ë¶€ëŠ” ê¾¸ì¤€íˆ ê´€ë¦¬í•  ë•Œ ë” ì¢‹ì•„ì ¸ìš”.<br>30ì¼ ë’¤ì— ë‹¤ì‹œ ë¶„ì„í•´ì„œ ì–´ë–»ê²Œ ë‹¬ë¼ì¡ŒëŠ”ì§€ ê¼­ í™•ì¸í•´ë³´ì„¸ìš”!</p>
            </div>
            <div class="disclaimer-section">
                <h4>ì‚¬ìš© ì‹œ ìœ ì˜ì‚¬í•­</h4>
                <p>ë³¸ ì¶”ì²œì€ AI ê¸°ë°˜ ì§„ë‹¨ ê²°ê³¼ë¡œ, ì‹¤ì œ íš¨ëŠ¥ì€ ê°œì¸ì˜ í”¼ë¶€ ìƒíƒœ ë° ë°˜ì‘ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆì–´ìš”.<br>íŠ¹ì • ì„±ë¶„ì— ì•Œë ˆë¥´ê¸°ê°€ ìˆìœ¼ì‹  ê²½ìš° ì œí’ˆ ì „ì„±ë¶„ì„ ë°˜ë“œì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
            </div>
        </div>
      </div>
    </div>

    <div style="text-align: center; margin: 40px 0;">
        <a href="{{ url_for('routines') }}" class="product-link">Click!</a>
    </div>
    {% endif %}
</div>

<!-- The Modal for Detailed Results -->
<div id="resultModal" class="modal">
  <div class="modal-content">
    <span class="close-button">&times;</span>
    <div class="all-result-container">
        <h2>AI í”¼ë¶€ ë¶„ì„ ê²°ê³¼ (ìƒì„¸)</h2>
        <div class="chart-container">
            <div id="gauge-chart" class="chart-item"></div>
            <div id="segmented-bars-container" class="chart-item">
                <div class="bar-container">
                    <span class="bar-label">ìˆ˜ë¶„</span>
                    <div class="segmented-bar" data-score="{{ scores.moisture | default(0, true) }}">
                        <div class="segment"></div><div class="segment"></div><div class="segment"></div><div class="segment"></div><div class="segment"></div>
                    </div>
                </div>
                <div class="bar-container">
                    <span class="bar-label">íƒ„ë ¥</span>
                    <div class="segmented-bar" data-score="{{ scores.elasticity | default(0, true) }}">
                        <div class="segment"></div><div class="segment"></div><div class="segment"></div><div class="segment"></div><div class="segment"></div>
                    </div>
                </div>
                <div class="bar-container">
                    <span class="bar-label">ì£¼ë¦„</span>
                    <div class="segmented-bar" data-score="{{ scores.wrinkle | default(0, true) }}">
                        <div class="segment"></div><div class="segment"></div><div class="segment"></div><div class="segment"></div><div class="segment"></div>
                    </div>
                </div>
            </div>
            <div class="flex-spacer"></div>
        </div>
        <div class="result-details-box">
            <div class="result-description">
                 <p>{{ result_summary | safe }}</p>
            </div>
            <div class="button-group">
                <a href="{{ url_for('analysis') }}" class="result-button-retry">ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•˜ê¸°</a>
            </div>
        </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Modal 1: Detailed Results --- 
        const resultModal = document.getElementById('resultModal');
        const showResultBtn = document.getElementById('showResultModalBtn');
        const resultCloseSpan = document.querySelector('#resultModal .close-button');
        let chartsRendered = false;

        function renderCharts() {
            if (chartsRendered) return;
            var mainScore = {{ main_score | default(0) }};
            var gaugeOptions = {
                series: [mainScore],
                chart: { height: 350, type: 'radialBar' },
                plotOptions: {
                    radialBar: {
                        startAngle: -135,
                        endAngle: 135,
                        hollow: { margin: 0, size: '70%', background: '#fff' },
                        track: { background: '#f2f2f2', strokeWidth: '67%' },
                        dataLabels: {
                            name: { show: true, offsetY: -25, fontSize: '16px', color: '#888', formatter: function(val) { return "Total Score" } },
                            value: { offsetY: 30, fontSize: '4.2rem', color: '#1f1f1fff', formatter: function (val) { return val.toFixed(0); } }
                        }
                    }
                },
                labels: ['ì¢…í•© ì ìˆ˜'],
                colors: ['#D8AAAA'],
                fill: { type: 'gradient', gradient: { shade: 'dark', type: 'horizontal', shadeIntensity: 0.5, gradientToColors: ['#C79999'], inverseColors: true, opacityFrom: 1, opacityTo: 1, stops: [0, 100] } },
                stroke: { lineCap: 'round' },
            };
            var gaugeChart = new ApexCharts(document.querySelector("#gauge-chart"), gaugeOptions);
            gaugeChart.render();

            document.querySelectorAll('.segmented-bar').forEach(bar => {
                const score = parseFloat(bar.dataset.score);
                let level = 0;
                if (score < 20) level = 1; else if (score < 40) level = 2; else if (score < 60) level = 3; else if (score < 80) level = 4; else level = 5;
                const segments = bar.querySelectorAll('.segment');
                for (let i = 0; i < level; i++) {
                    if(segments[i]) { segments[i].classList.add('filled'); }
                }
            });
            chartsRendered = true;
        }

        if (showResultBtn) {
            showResultBtn.onclick = function() {
              resultModal.style.display = "block";
              renderCharts();
            }
        }
        if (resultCloseSpan) {
            resultCloseSpan.onclick = function() {
              resultModal.style.display = "none";
            }
        }

        // --- Modal 2: Info/Guide ---
        const infoModal = document.getElementById('infoModal');
        const showInfoBtn = document.getElementById('toggleInfoBtn');
        const infoCloseSpan = document.querySelector('#infoModal .close-button');

        if (showInfoBtn) {
            showInfoBtn.onclick = function() {
              infoModal.style.display = "block";
            }
        }
        if (infoCloseSpan) {
            infoCloseSpan.onclick = function() {
              infoModal.style.display = "none";
            }
        }

        // --- General Modal Handling ---
        window.onclick = function(event) {
          if (event.target == resultModal) {
            resultModal.style.display = "none";
          }
          if (event.target == infoModal) {
            infoModal.style.display = "none";
          }
        }
    });
</script>
{% endblock %}
